/* @noflow */

Sentry.init({
  environment: '<%= Rails.env %>',
  dsn: 'https://da1bc9fe1d2e4fd89349d6ff82fca30e@sentry.io/1309103',
  enableTracing: false,
  beforeSend(event) {
    try {
      JSON.stringify(event)
      return event
    } catch (err) {
      const sanitizedEvent = { ...event }
      if (sanitizedEvent.extra) {
        Object.keys(sanitizedEvent.extra).forEach(key => {
          try {
            JSON.stringify(sanitizedEvent.extra[key])
          } catch (e) {
            sanitizedEvent.extra[key] = '[Removed Non-Serializable Data]'
          }
        })
      }
      return sanitizedEvent
    }
  }
})

if (window.reader != null) {
  const user = {
    email: window.reader.email,
    id: window.reader.id,
  }

  if (typeof Sentry.setUser === 'function') {
    Sentry.setUser(user)
  } else if (typeof Sentry.configureScope === 'function') {
    Sentry.configureScope(scope => scope.setUser(user))
  }
}

window.sentryLog = function sentryLog(level, message, extra = {}) {
  Sentry.captureMessage(message, { level, extra })
}
