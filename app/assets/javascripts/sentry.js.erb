/* @noflow */

Sentry.init({
  environment: '<%= Rails.env %>',
  dsn: 'https://da1bc9fe1d2e4fd89349d6ff82fca30e@sentry.io/1309103',
  beforeSend(event) {
    // Ensure the event is serializable and doesn't contain circular references
    try {
      JSON.stringify(event);
      if ('<%= Rails.env %>' === 'development') {
        console.log('event', event);
      }
      return event;
    } catch (err) {
      // If the event can't be stringified, create a sanitized copy
      const sanitizedEvent = {
        ...event,
        extra: {},
        contexts: {},
        tags: { ...event.tags },
        breadcrumbs: event.breadcrumbs?.map(crumb => ({
          ...crumb,
          data: {}
        }))
      };
      return sanitizedEvent;
    }
  }
})

Sentry.configureScope((scope) => {
  if (window.reader != null) scope.setUser({ email: window.reader.email })
})
